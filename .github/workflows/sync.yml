name: Upstream Sync

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}
    env:
      TZ: Asia/Shanghai
      UPSTREAM_REPO: senshinya/MoonTV
      UPSTREAM_BRANCH: main
      TARGET_BRANCH: main

    steps:
      - name: Check environment information
        run: |
          echo "Repo: ${{ github.repository }}"
          echo "Upstream: $UPSTREAM_REPO:$UPSTREAM_BRANCH"
          echo "Target: $TARGET_BRANCH"

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}
          token: ${{ secrets.PATTOKEN }}  # 用PAT确保权限

      - name: Network test
        run: |
          ping github.com -c 2
          curl -sSL "https://github.com/$UPSTREAM_REPO" | head -n 3

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/$UPSTREAM_REPO.git || true  # 避免重复添加报错
          git fetch upstream  # 获取上游最新代码

      - name: Configure git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Merge upstream changes with retry
        run: |
          git checkout $TARGET_BRANCH
          git pull origin $TARGET_BRANCH --rebase  # 同步本地与远程目标分支
          
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts to merge upstream..."
            if git merge upstream/$UPSTREAM_BRANCH --no-edit; then
              git push origin $TARGET_BRANCH
              echo "Sync successful"
              exit 0
            else
              echo "Merge failed. Checking conflicts..."
              git status
              git merge --abort  # 中止当前合并，避免影响下次尝试
              attempt=$((attempt + 1))
              [ $attempt -le $max_attempts ] && sleep 30
            fi
          done
          echo "Sync failed after $max_attempts attempts"
          exit 1

      - name: Delete old workflow runs
        if: success()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.PATTOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 2





